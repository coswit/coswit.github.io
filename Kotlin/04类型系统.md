##  nullability

Kotlin对`NullPointerException`的处理是把它转变为编译期的错误。null类型需要显式指定，如`Type?`表示 `Type or null`。

对不支持`null`类型的需要特殊处理：

```kotlin
fun strLenSafe(s: String?): Int = if (s != null) s.length else 0
```

### 安全调用符`?.`

`?.` 的含义就是 **"如果不为 null，就继续；否则整个表达式返回 null"**

<img src="./Kotlin/images/25.jpg" />

```kotlin
class Address(
    val streetAddress: String, val zipCode: Int,
    val city: String, val country: String
)

class Company(val name: String, val address: Address?)

class Person(val name: String, val company: Company?)

fun Person.countryName(): String {
    val country = this.company?.address?.country
    return if (country != null) country else "Unknown"
}

fun main(args: Array<String>) {
    val person = Person("Dmitry", null)
    println(person.countryName())
}
//Unknown
```

### Elvis运算符`?:`

左边不为 `null` 就用左边，左边为 `null` 就用右边的默认值

<img src="./Kotlin/images/23.jpg" />

```kotlin
val result = a ?: b ?: c ?: "最终默认值"
// 从左到右，第一个非 null 的值胜出
```

### 安全转换符`as?`

<img src="./Kotlin/images/27.jpg" />

```kotlin
class Person(val firstName: String, val lastName: String) {
    override fun equals(o: Any?): Boolean {
        val otherPerson = o as? Person ?: return false
        return otherPerson.firstName == firstName && otherPerson.lastName == lastName
    }

    override fun hashCode(): Int = firstName.hashCode() * 37 + lastName.hashCode()
}

fun main(args: Array<String>) {
    val p1 = Person("Dmitry", "Jemerov")
    val p2 = Person("Dmitry", "Jemerov")
    println(p1 == p2)
    println(p1.equals(42))
}

// true false
```

### 非空断言符`!!`

<img src="./Kotlin/images/10.jpg" />

对`null`值做非空断言，会抛出异常：

```kotlin
fun ignoreNulls(s: String?) {
    val sNotNull: String = s!!
    println(sNotNull.length)
}

fun main(args: Array<String>) {
    ignoreNulls(null)
}
```

### let

<img src="./Kotlin/images/28.jpg" />

```kotlin
val result = obj.let {
    // it 就是 obj
    // 最后一行作为返回值
}

val length = "Hello".let {
    println("字符串是：$it")
    it.length  // 返回 Int
}
println(length)  // 5
```

```kotlin
val name: String? = "Alice"

name?.let {
    println(it.uppercase())  // 只有 name 非 null 才执行
    println(it.length)
}
```

## 数据类型

### 基本数据类型

Kotlin不区分基本数据类型和包装数据类型。

### Any

`Any` 是 Kotlin 中**所有类的根类**，相当于 Java 中的 `Object`。Kotlin 里每一个类都直接或间接继承自 `Any`。`Any` 是非空类型，`Any?` 才能接收 null。

`Any` 只定义了三个方法，所有类都继承它们:

```kotlin
public open class Any {
    open operator fun equals(other: Any?): Boolean
    open fun hashCode(): Int
    open fun toString(): String
}
```

### Unit

相当于Java中的void，是一个完备的类型，可以作为类型参数。

```kotlin
fun f(): Unit { ... }
```

在泛型中可以作为参数使用：

```kotlin
interface Callback<T> {
    fun onResult(result: T)
}

// 如果不需要返回值，用 Unit 填充泛型
val callback: Callback<Unit> = object : Callback<Unit> {
    override fun onResult(result: Unit) {
        println("完成了")
    }
}
```

在函数式编程场景下尤其有用：

```kotlin
val action: () -> Unit = { println("执行") }

// 高阶函数中统一用 Unit 表示无返回值
fun runTask(task: () -> Unit) {
    task()
}
```

### Nothing

`Nothing` 表示**永远不会正常返回的函数**，比如总是抛异常、或者无限循环。它不是"没有值"，而是"根本不会有值"。

```kotlin
fun fail(message: String): Nothing {
    throw IllegalStateException(message)
}

fun main(args: Array<String>) {
    fail("Error occurred")
}
```

`Nothing`是所有类型的子类型，可以赋值给任意类型，编译器不会报错：

```kotlin
kotlinval value: String = if (condition) {
    "Hello"
} else {
    throw RuntimeException()  // 这个分支类型是 Nothing
}
```

## 集合和数组

`List<int?>`与`List<int>?`的区别：

<img src="./Kotlin/images/21.jpg" />

在Kotlin中将访问集合的接口和修改集合的接口分开了，如果函数接收`Collection`类型表示它不会修改集合，如果是修改集合则会使用`MutableCollection`作为参数。

```kotlin
fun <T> copyElements(source: Collection<T>, target: MutableCollection<T>) {
    for (item in source) {
        target.add(item)
    }
}

fun main(args: Array<String>) {
    val source: Collection<Int> = arrayListOf(3, 5, 7)
    val target: MutableCollection<Int> = arrayListOf(1)
    copyElements(source, target)
    println(target)
}
```

每一种Java集合在Kotlin中都有两种表示：一种是可读的，一种的可修改的。

| 集合类型 | 只读   | 可变                                            |
| -------- | ------ | ----------------------------------------------- |
| List     | listOf | mutableListOf、arrayListOf                      |
| Set      | setOf  | mutableSetOf、hashSetOf、linkedSetOf、sortSetOf |
| Map      | mapOf  | mutableMapOf、hashMapOf、linkedMapOf、sortMapOf |

